{% extends "base.html" %}

{% block title %}多Agent协作工坊 - iDOC{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/multi_agent.css') }}">
<style>
    .agent-workshop-container {
        display: flex;
        height: calc(100vh - 60px);
        overflow: hidden;
    }
    
    .agent-sidebar {
        width: 280px;
        background-color: #fff;
        border-right: 1px solid #e5e9f2;
        display: flex;
        flex-direction: column;
    }
    
    .agent-sidebar-header {
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e5e9f2;
    }
    
    .agent-sidebar-title {
        margin: 0;
        font-size: 1.1rem;
    }
    
    .agent-team {
        padding: 1rem;
        border-bottom: 1px solid #e5e9f2;
    }
    
    .team-title {
        font-size: 0.85rem;
        color: #64748b;
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .add-agent-btn {
        background: none;
        border: none;
        color: #4A6CF7;
        cursor: pointer;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .agent-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .agent-card {
        background-color: #f8fafc;
        border: 1px solid #e5e9f2;
        border-radius: 8px;
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .agent-card:hover {
        border-color: #4A6CF7;
        background-color: rgba(74, 108, 247, 0.05);
    }
    
    .agent-card.active {
        border-color: #4A6CF7;
        background-color: rgba(74, 108, 247, 0.1);
    }
    
    .agent-header {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .agent-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        color: white;
    }
    
    .agent-icon.legal {
        background-color: #8b5cf6;
    }
    
    .agent-icon.financial {
        background-color: #10b981;
    }
    
    .agent-icon.data {
        background-color: #f59e0b;
    }
    
    .agent-icon.workflow {
        background-color: #ef4444;
    }
    
    .agent-name {
        font-weight: 600;
        font-size: 0.95rem;
    }
    
    .agent-role {
        font-size: 0.8rem;
        color: #64748b;
        margin-bottom: 0.5rem;
    }
    
    .agent-skills {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .agent-skill {
        background-color: #e5e9f2;
        color: #64748b;
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
    }
    
    .agent-status {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #10b981;
    }
    
    .agent-status.idle {
        background-color: #94a3b8;
    }
    
    .agent-status.busy {
        background-color: #f59e0b;
    }
    
    .context-section {
        padding: 1rem;
        border-bottom: 1px solid #e5e9f2;
    }
    
    .context-title {
        font-size: 0.85rem;
        color: #64748b;
        margin-bottom: 0.75rem;
    }
    
    .document-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .document-item {
        display: flex;
        align-items: center;
        background-color: #f8fafc;
        border: 1px solid #e5e9f2;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .document-item:hover {
        border-color: #4A6CF7;
        background-color: rgba(74, 108, 247, 0.05);
    }
    
    .document-item i {
        margin-right: 0.5rem;
        color: #4A6CF7;
    }
    
    .document-item.selected {
        border-color: #4A6CF7;
        background-color: rgba(74, 108, 247, 0.1);
    }
    
    .workshop-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #f8fafc;
    }
    
    .workshop-header {
        padding: 0.75rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #fff;
        border-bottom: 1px solid #e5e9f2;
    }
    
    .workshop-title {
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .workshop-actions {
        display: flex;
        gap: 0.75rem;
    }
    
    .workshop-action-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        background-color: #f8fafc;
        border: 1px solid #e5e9f2;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.85rem;
    }
    
    .workshop-action-btn:hover {
        background-color: rgba(74, 108, 247, 0.05);
        border-color: #4A6CF7;
        color: #4A6CF7;
    }
    
    .workshop-action-btn.primary {
        background-color: #4A6CF7;
        border-color: #4A6CF7;
        color: white;
    }
    
    .workshop-action-btn.primary:hover {
        background-color: #3a5ad1;
    }
    
    .workshop-content {
        flex: 1;
        display: flex;
        overflow: hidden;
    }
    
    .conversation-panel {
        width: 60%;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #e5e9f2;
    }
    
    .conversation-body {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
    }
    
    .conversation-footer {
        padding: 1rem 1.5rem;
        background-color: #fff;
        border-top: 1px solid #e5e9f2;
    }
    
    .insights-panel {
        width: 40%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .insights-header {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e5e9f2;
        display: flex;
        align-items: center;
        background-color: #fff;
    }
    
    .insights-title {
        font-weight: 600;
        margin: 0;
    }
    
    .insights-body {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }
    
    .insights-section {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        margin-bottom: 1rem;
        overflow: hidden;
    }
    
    .insights-section-header {
        padding: 0.75rem 1rem;
        background-color: #f8fafc;
        border-bottom: 1px solid #e5e9f2;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .insights-section-body {
        padding: 1rem;
    }
    
    .insights-agent {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .insights-agent-icon {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.5rem;
        color: white;
        font-size: 0.75rem;
    }
    
    .insights-agent-name {
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .key-finding {
        margin-bottom: 0.75rem;
        padding-left: 1.75rem;
        position: relative;
    }
    
    .key-finding::before {
        content: '';
        position: absolute;
        left: 0.75rem;
        top: 0.5rem;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #4A6CF7;
    }
    
    .key-finding-critical::before {
        background-color: #ef4444;
    }
    
    .key-finding-warning::before {
        background-color: #f59e0b;
    }
    
    .key-finding-positive::before {
        background-color: #10b981;
    }
    
    .key-finding-content {
        font-size: 0.9rem;
    }
    
    .findings-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }
    
    /* 使用统一的按钮样式 */
    
    .collaboration-message {
        margin-bottom: 1.5rem;
        display: flex;
        flex-direction: column;
    }
    
    .message-agents {
        display: flex;
        margin-bottom: 0.5rem;
    }
    
    .message-agent {
        display: flex;
        align-items: center;
        background-color: #f8fafc;
        border: 1px solid #e5e9f2;
        border-radius: 20px;
        padding: 0.25rem 0.75rem;
        margin-right: 0.5rem;
        font-size: 0.85rem;
    }
    
    .message-agent i {
        margin-right: 0.4rem;
    }
    
    .message-agent.from {
        background-color: rgba(74, 108, 247, 0.1);
        border-color: rgba(74, 108, 247, 0.2);
        font-weight: 600;
    }
    
    .message-content {
        background-color: #fff;
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .highlighted-term {
        background-color: rgba(74, 108, 247, 0.1);
        border-radius: 2px;
        padding: 0.1rem 0.25rem;
        color: #4A6CF7;
        font-weight: 500;
    }
    
    .message-content ul {
        padding-left: 1.5rem;
        margin-bottom: 0;
    }
    
    .message-content li {
        margin-bottom: 0.5rem;
    }
    
    .message-content li:last-child {
        margin-bottom: 0;
    }
    
    .message-content p {
        margin-top: 0;
        margin-bottom: 0.75rem;
    }
    
    .message-content p:last-child {
        margin-bottom: 0;
    }
    
    .message-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }
    
    .action-button {
        height: 32px;
        padding: 0 10px;
        font-size: 0.8rem;
        border-radius: 4px;
        background-color: #f8fafc;
        border: 1px solid #e5e9f2;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        white-space: nowrap;
        margin-right: 5px;
        margin-bottom: 5px;
    }
    
    .action-button:hover {
        background-color: rgba(74, 108, 247, 0.05);
        border-color: #4A6CF7;
        color: #4A6CF7;
    }
    
    .action-button.primary {
        background-color: rgba(74, 108, 247, 0.1);
        border-color: rgba(74, 108, 247, 0.2);
        color: #4A6CF7;
    }
    
    .prompt-input-container {
        display: flex;
        flex-direction: column;
    }
    
    .prompt-input {
        width: 100%;
        border: 1px solid #e5e9f2;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        max-height: 120px;
        min-height: 40px;
        resize: none;
        outline: none;
        font-family: inherit;
        font-size: inherit;
        line-height: 1.5;
        transition: all 0.2s ease;
        margin-bottom: 0.75rem;
    }
    
    .prompt-input:focus {
        border-color: #4A6CF7;
        box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
    }
    
    .prompt-actions {
        display: flex;
        justify-content: space-between;
    }
    
    .prompt-targets {
        display: flex;
        gap: 0.5rem;
    }
    
    .target-agent {
        display: flex;
        align-items: center;
        background-color: #f8fafc;
        border: 1px solid #e5e9f2;
        border-radius: 6px;
        padding: 0.4rem 0.75rem;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .target-agent.selected {
        background-color: rgba(74, 108, 247, 0.1);
        border-color: rgba(74, 108, 247, 0.2);
    }
    
    .target-agent i {
        margin-right: 0.4rem;
    }
    
    .prompt-submit {
        display: flex;
        gap: 0.5rem;
    }
    
    .submit-btn {
        padding: 0.4rem 0.75rem;
        background-color: #4A6CF7;
        color: white;
        border: 1px solid #4A6CF7;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .submit-btn:hover {
        background-color: #3a5ad1;
    }
    
    .submit-options-btn {
        padding: 0.4rem 0.75rem;
        background-color: #f8fafc;
        border: 1px solid #e5e9f2;
        border-radius: 6px;
        cursor: pointer;
        color: #64748b;
        transition: all 0.2s ease;
    }
    
    .submit-options-btn:hover {
        background-color: rgba(74, 108, 247, 0.05);
        border-color: #4A6CF7;
        color: #4A6CF7;
    }
    
    .insight-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #94a3b8;
        margin-top: 0.5rem;
    }
    
    .insight-meta-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    @media (max-width: 1200px) {
        .conversation-panel {
            width: 55%;
        }
        
        .insights-panel {
            width: 45%;
        }
    }
    
    @media (max-width: 992px) {
        .workshop-content {
            flex-direction: column;
        }
        
        .conversation-panel {
            width: 100%;
            border-right: none;
            border-bottom: 1px solid #e5e9f2;
            height: 60%;
        }
        
        .insights-panel {
            width: 100%;
            height: 40%;
        }
    }
    
    /* 处理中指示器样式 */
    .processing-indicator {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        background-color: rgba(74, 108, 247, 0.05);
        border-radius: 8px;
        padding: 1rem;
        border-left: 4px solid #4A6CF7;
    }
    
    .processing-animation {
        font-size: 1.5rem;
        color: #4A6CF7;
        flex-shrink: 0;
    }
    
    .processing-text {
        flex: 1;
    }
    
    .processing-text p {
        margin-top: 0.5rem;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
        color: #64748b;
    }
    
    /* Agent 开关控制样式 */
    .agent-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 0.75rem;
        padding-top: 0.5rem;
        border-top: 1px dashed #e5e9f2;
    }
    
    .toggle-label {
        font-size: 0.8rem;
        color: #64748b;
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 36px;
        height: 20px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #e5e9f2;
        transition: .4s;
        border-radius: 20px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
        background-color: #4A6CF7;
    }
    
    input:focus + .toggle-slider {
        box-shadow: 0 0 1px #4A6CF7;
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(16px);
    }

    @media (max-width: 768px) {
        .agent-sidebar {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- 左侧导航栏 -->
    <div class="sidebar">
        <div class="sidebar-brand">
            <a href="{{ url_for('dashboard') }}">
                <div class="sidebar-brand-icon">
                    <img src="{{ url_for('static', filename='img/logo-icon.svg') }}" alt="Logo Icon" onerror="this.src='{{ url_for('static', filename='img/default-logo.png') }}'">
                </div>
                <div class="sidebar-brand-text">
                    <img src="{{ url_for('static', filename='img/logo-text.svg') }}" alt="Logo Text" onerror="this.src='{{ url_for('static', filename='img/default-logo-text.png') }}'">
                    <span>iDOC</span>
                </div>
            </a>
        </div>
        
        <!-- 导航菜单 -->
        <div class="sidebar-nav">
            <a href="{{ url_for('dashboard') }}" class="nav-item">
                <i class="fas fa-tachometer-alt"></i>
                <span>仪表板</span>
            </a>
            
            <div class="nav-item" data-bs-toggle="collapse" data-bs-target="#collapseKnowledgeBase" aria-expanded="false">
                <i class="fas fa-book"></i>
                <span>企业知识库</span>
                <i class="fas fa-chevron-down ms-auto"></i>
            </div>
            <div class="collapse" id="collapseKnowledgeBase">
                <a href="{{ url_for('knowledge_base') }}" class="nav-item ms-4 py-2">
                    <i class="fas fa-folder-open"></i>
                    <span>所有知识库</span>
                </a>
                <a href="{{ url_for('knowledge_base') }}?action=import" class="nav-item ms-4 py-2">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>导入知识</span>
                </a>
                <a href="{{ url_for('knowledge_base') }}?action=settings" class="nav-item ms-4 py-2">
                    <i class="fas fa-cogs"></i>
                    <span>知识库设置</span>
                </a>
            </div>
            
            <div class="nav-item" data-bs-toggle="collapse" data-bs-target="#collapseDocuments" aria-expanded="false">
                <i class="fas fa-file-alt"></i>
                <span>文档管理</span>
                <i class="fas fa-chevron-down ms-auto"></i>
            </div>
            <div class="collapse" id="collapseDocuments">
                <a href="{{ url_for('documents_list') }}" class="nav-item ms-4 py-2">
                    <i class="fas fa-list"></i>
                    <span>所有文档</span>
                </a>
                <a href="{{ url_for('documents_list') }}?action=upload" class="nav-item ms-4 py-2">
                    <i class="fas fa-upload"></i>
                    <span>上传文档</span>
                </a>
                <a href="{{ url_for('documents_list') }}?action=recent" class="nav-item ms-4 py-2">
                    <i class="fas fa-clock"></i>
                    <span>最近文档</span>
                </a>
                <a href="{{ url_for('documents_list') }}?action=starred" class="nav-item ms-4 py-2">
                    <i class="fas fa-star"></i>
                    <span>星标文档</span>
                </a>
            </div>
            
            <div class="nav-item" data-bs-toggle="collapse" data-bs-target="#collapseWorkflow" aria-expanded="false">
                <i class="fas fa-project-diagram"></i>
                <span>工作流管理</span>
                <i class="fas fa-chevron-down ms-auto"></i>
            </div>
            <div class="collapse" id="collapseWorkflow">
                <a href="{{ url_for('workflow_create') }}" class="nav-item ms-4 py-2">
                    <i class="fas fa-plus"></i>
                    <span>创建工作流</span>
                </a>
                <a href="{{ url_for('workflow_create') }}?action=templates" class="nav-item ms-4 py-2">
                    <i class="fas fa-clipboard-list"></i>
                    <span>工作流模板</span>
                </a>
                <a href="{{ url_for('workflow_create') }}?action=running" class="nav-item ms-4 py-2">
                    <i class="fas fa-play-circle"></i>
                    <span>运行中工作流</span>
                </a>
                <a href="{{ url_for('workflow_create') }}?action=history" class="nav-item ms-4 py-2">
                    <i class="fas fa-history"></i>
                    <span>历史工作流</span>
                </a>
            </div>
            
            <div class="nav-item" data-bs-toggle="collapse" data-bs-target="#collapseAnalysis" aria-expanded="false">
                <i class="fas fa-chart-bar"></i>
                <span>AI分析</span>
                <i class="fas fa-chevron-down ms-auto"></i>
            </div>
            <div class="collapse" id="collapseAnalysis">
                <a href="{{ url_for('ai_analysis') }}" class="nav-item ms-4 py-2">
                    <i class="fas fa-search"></i>
                    <span>内容分析</span>
                </a>
                <a href="{{ url_for('ai_analysis') }}?action=compare" class="nav-item ms-4 py-2">
                    <i class="fas fa-not-equal"></i>
                    <span>文档对比</span>
                </a>
                <a href="{{ url_for('ai_analysis') }}?action=extract" class="nav-item ms-4 py-2">
                    <i class="fas fa-filter"></i>
                    <span>信息提取</span>
                </a>
                <a href="{{ url_for('ai_analysis') }}?action=summary" class="nav-item ms-4 py-2">
                    <i class="fas fa-compress-alt"></i>
                    <span>文档摘要</span>
                </a>
            </div>
            
            <div class="nav-item" data-bs-toggle="collapse" data-bs-target="#collapseAgent" aria-expanded="true">
                <i class="fas fa-robot"></i>
                <span>Agent Chat</span>
                <i class="fas fa-chevron-down ms-auto"></i>
            </div>
            <div class="collapse show" id="collapseAgent">
                <a href="{{ url_for('agent_chat') }}" class="nav-item ms-4 py-2">
                    <i class="fas fa-comments"></i>
                    <span>新会话</span>
                </a>
                <a href="{{ url_for('agent_chat_history') }}" class="nav-item ms-4 py-2">
                    <i class="fas fa-history"></i>
                    <span>聊天历史</span>
                </a>
                <a href="{{ url_for('multi_agent_workshop') }}" class="nav-item ms-4 py-2 active">
                    <i class="fas fa-users-cog"></i>
                    <span>多Agent协作</span>
                </a>
                <a href="{{ url_for('agent_settings') }}" class="nav-item ms-4 py-2">
                    <i class="fas fa-sliders-h"></i>
                    <span>Agent设置</span>
                </a>
            </div>
            
            <div class="nav-section">用户</div>
            
            <a href="{{ url_for('account_settings') }}" class="nav-item">
                <i class="fas fa-user-cog"></i>
                <span>账户设置</span>
            </a>
            
            <a href="{{ url_for('notifications') }}" class="nav-item">
                <i class="fas fa-bell"></i>
                <span>通知</span>
                <span class="badge rounded-pill bg-primary ms-auto">3</span>
            </a>
            
            <a href="{{ url_for('logout') }}" class="nav-item">
                <i class="fas fa-sign-out-alt"></i>
                <span>退出登录</span>
            </a>
        </div>
    </div>
    
    <!-- 主内容区域 -->
    <div class="main-content">
        <div class="agent-workshop-container">
            <!-- Agent面板 -->
            <div class="agent-sidebar">
                <div class="agent-sidebar-header">
                    <h5 class="agent-sidebar-title">Agent协作团队</h5>
                </div>
                
                <!-- 专家团队 -->
                <div class="agent-team">
                    <div class="team-title">
                        <span>专业领域Agent</span>
                        <button class="add-agent-btn">
                            <i class="fas fa-plus"></i>
                            <span>添加</span>
                        </button>
                    </div>
                    
                    <div class="agent-list">
                        <div class="agent-card active">
                            <div class="agent-status"></div>
                            <div class="agent-header">
                                <div class="agent-icon legal">
                                    <i class="fas fa-gavel"></i>
                                </div>
                                <div class="agent-name">法律专家</div>
                            </div>
                            <div class="agent-role">合同分析与法律合规审查</div>
                            <div class="agent-skills">
                                <div class="agent-skill">合同审核</div>
                                <div class="agent-skill">法律风险</div>
                                <div class="agent-skill">条款分析</div>
                            </div>
                            <div class="agent-toggle">
                                <div class="toggle-label">启用</div>
                                <label class="toggle-switch">
                                    <input type="checkbox" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="agent-card">
                            <div class="agent-status"></div>
                            <div class="agent-header">
                                <div class="agent-icon financial">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="agent-name">财务分析师</div>
                            </div>
                            <div class="agent-role">财务数据分析与报表解读</div>
                            <div class="agent-skills">
                                <div class="agent-skill">财务报表</div>
                                <div class="agent-skill">成本分析</div>
                                <div class="agent-skill">预算规划</div>
                            </div>
                            <div class="agent-toggle">
                                <div class="toggle-label">启用</div>
                                <label class="toggle-switch">
                                    <input type="checkbox" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="agent-card">
                            <div class="agent-status busy"></div>
                            <div class="agent-header">
                                <div class="agent-icon data">
                                    <i class="fas fa-database"></i>
                                </div>
                                <div class="agent-name">数据分析师</div>
                            </div>
                            <div class="agent-role">数据挖掘与统计分析</div>
                            <div class="agent-skills">
                                <div class="agent-skill">数据可视化</div>
                                <div class="agent-skill">模式识别</div>
                                <div class="agent-skill">趋势预测</div>
                            </div>
                            <div class="agent-toggle">
                                <div class="toggle-label">启用</div>
                                <label class="toggle-switch">
                                    <input type="checkbox" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="agent-card">
                            <div class="agent-status idle"></div>
                            <div class="agent-header">
                                <div class="agent-icon workflow">
                                    <i class="fas fa-sitemap"></i>
                                </div>
                                <div class="agent-name">流程专家</div>
                            </div>
                            <div class="agent-role">业务流程优化与项目管理</div>
                            <div class="agent-skills">
                                <div class="agent-skill">流程设计</div>
                                <div class="agent-skill">效率优化</div>
                                <div class="agent-skill">项目规划</div>
                            </div>
                            <div class="agent-toggle">
                                <div class="toggle-label">启用</div>
                                <label class="toggle-switch">
                                    <input type="checkbox" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="agent-card">
                            <div class="agent-status idle"></div>
                            <div class="agent-header">
                                <div class="agent-icon" style="background-color: #8B5CF6;">
                                    <i class="fas fa-file-signature"></i>
                                </div>
                                <div class="agent-name">合规专家</div>
                            </div>
                            <div class="agent-role">行业法规与合规性评估</div>
                            <div class="agent-skills">
                                <div class="agent-skill">合规审核</div>
                                <div class="agent-skill">风险管控</div>
                                <div class="agent-skill">政策解读</div>
                            </div>
                            <div class="agent-toggle">
                                <div class="toggle-label">启用</div>
                                <label class="toggle-switch">
                                    <input type="checkbox">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="agent-card">
                            <div class="agent-status idle"></div>
                            <div class="agent-header">
                                <div class="agent-icon" style="background-color: #059669;">
                                    <i class="fas fa-industry"></i>
                                </div>
                                <div class="agent-name">行业专家</div>
                            </div>
                            <div class="agent-role">行业趋势与竞争分析</div>
                            <div class="agent-skills">
                                <div class="agent-skill">市场分析</div>
                                <div class="agent-skill">竞争研究</div>
                                <div class="agent-skill">战略规划</div>
                            </div>
                            <div class="agent-toggle">
                                <div class="toggle-label">启用</div>
                                <label class="toggle-switch">
                                    <input type="checkbox">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 上下文文档 -->
                <div class="context-section">
                    <div class="context-title">相关文档上下文</div>
                    
                    <div class="document-list">
                        <div class="document-item selected">
                            <i class="fas fa-file-contract"></i>
                            <span>供应商采购合同-2025.docx</span>
                        </div>
                        <div class="document-item">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span>财务报表Q2-2025.xlsx</span>
                        </div>
                        <div class="document-item">
                            <i class="fas fa-file-alt"></i>
                            <span>项目计划书.docx</span>
                        </div>
                        <div class="document-item">
                            <i class="fas fa-file-pdf"></i>
                            <span>行业报告2025.pdf</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 协作主区域 -->
            <div class="workshop-main">
                <div class="workshop-header">
                    <div class="workshop-title">多Agent协作分析工坊</div>
                    <div class="workshop-actions">
                        <button class="workshop-action-btn">
                            <i class="fas fa-plus"></i>
                            <span>新建分析</span>
                        </button>
                        <button class="workshop-action-btn">
                            <i class="fas fa-history"></i>
                            <span>历史会话</span>
                        </button>
                        <button class="workshop-action-btn">
                            <i class="fas fa-file-upload"></i>
                            <span>上传文档</span>
                        </button>
                        <button class="workshop-action-btn">
                            <i class="fas fa-cog"></i>
                            <span>设置</span>
                        </button>
                        <button class="workshop-action-btn primary">
                            <i class="fas fa-save"></i>
                            <span>保存分析</span>
                        </button>
                    </div>
                </div>
                
                <div class="workshop-content">
                    <!-- 对话面板 -->
                    <div class="conversation-panel">
                        <div class="conversation-body">
                            <!-- 系统信息 -->
                            <div class="collaboration-message">
                                <div class="message-content">
                                    <p><strong>Agent协作团队已初始化</strong></p>
                                    <p>本次分析已激活4位专业Agent：法律专家、财务分析师、数据分析师和流程专家。他们将协同工作，从不同专业角度分析您的文档和问题。</p>
                                    <p>请输入您的问题，或选择一个预设任务开始。您可以向特定Agent提问，也可以让系统协调多Agent回答。</p>
                                </div>
                            </div>
                            
                            <!-- 用户消息 -->
                            <div class="collaboration-message">
                                <div class="message-agents">
                                    <div class="message-agent from">
                                        <i class="fas fa-user"></i>
                                        <span>您</span>
                                    </div>
                                </div>
                                <div class="message-content">
                                    <p>请对这份供应商采购合同进行综合评估，我特别关注合同的法律风险和对我们财务的影响。</p>
                                </div>
                            </div>
                            
                            <!-- 系统消息 -->
                            <div class="collaboration-message">
                                <div class="message-content">
                                    <div class="processing-indicator">
                                        <div class="processing-animation">
                                            <i class="fas fa-sync-alt fa-spin"></i>
                                        </div>
                                        <div class="processing-text">
                                            <strong>Agent协作团队正在分析您的文档...</strong>
                                            <p>法律专家正在审核合同条款和风险点</p>
                                            <p>财务分析师正在评估财务影响和成本结构</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 法律专家回复 -->
                            <div class="collaboration-message">
                                <div class="message-agents">
                                    <div class="message-agent from">
                                        <i class="fas fa-gavel"></i>
                                        <span>法律专家</span>
                                    </div>
                                    <div class="message-agent">
                                        <i class="fas fa-clock"></i>
                                        <span>2分钟前</span>
                                    </div>
                                </div>
                                <div class="message-content">
                                    <p>我已完成对<span class="highlighted-term">供应商采购合同-2025.docx</span>的法律审核，发现以下法律风险点：</p>
                                    
                                    <ol>
                                        <li><strong>付款条款（第12条）</strong>：预付款比例高达70%，但缺乏足够的担保机制，建议添加对方提供银行保函或降低预付比例。</li>
                                        <li><strong>交付时间（第8条）</strong>：与附录B的时间表存在冲突，且缺乏明确的延期赔偿条款。</li>
                                        <li><strong>终止条款（第15条）</strong>：单方面终止权限设置不平等，对方可提前15天通知终止，我方则需90天，对我方极为不利。</li>
                                        <li><strong>知识产权（第18条）</strong>：知识产权保护条款过于宽泛，可能导致我方技术秘密泄露风险。</li>
                                    </ol>
                                    
                                    <p>综合评估，该合同<strong>法律风险等级为高</strong>，建议在签署前修改上述条款。</p>
                                    
                                    <div class="message-actions">
                                        <a href="#" class="action-button primary">
                                            <i class="fas fa-edit"></i>修改建议
                                        </a>
                                        <a href="#" class="action-button">
                                            <i class="fas fa-file-alt"></i>法律分析
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 财务分析师回复 -->
                            <div class="collaboration-message">
                                <div class="message-agents">
                                    <div class="message-agent from">
                                        <i class="fas fa-chart-line"></i>
                                        <span>财务分析师</span>
                                    </div>
                                    <div class="message-agent">
                                        <i class="fas fa-clock"></i>
                                        <span>1分钟前</span>
                                    </div>
                                </div>
                                <div class="message-content">
                                    <p>根据合同条款和我们的财务状况，我对这份采购合同的财务影响分析如下：</p>
                                    
                                    <ul>
                                        <li><strong>现金流压力</strong>：70%的预付款要求（约875,000元）将对Q3现金流造成显著压力，考虑到目前我们的现金储备，这可能需要动用信用额度。</li>
                                        <li><strong>成本结构</strong>：合同总价125万元比市场平均价高出12%，建议协商降价或寻求替代供应商。</li>
                                        <li><strong>支付条件</strong>：付款周期与我们标准的60天账期不符，将增加财务管理复杂性。</li>
                                        <li><strong>潜在隐形成本</strong>：交付延迟条款不明确，可能带来额外项目成本和资源占用。</li>
                                    </ul>
                                    
                                    <p>财务建议：重新协商付款条件，争取"30%预付+60%交付+10%验收"的阶段式付款方式，更符合我司现金流管理策略。</p>
                                    
                                    <div class="message-actions">
                                        <a href="#" class="action-button primary">
                                            <i class="fas fa-calculator"></i>现金流分析
                                        </a>
                                        <a href="#" class="action-button">
                                            <i class="fas fa-search-dollar"></i>成本优化
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 协作总结消息 -->
                            <div class="collaboration-message">
                                <div class="message-agents">
                                    <div class="message-agent from">
                                        <i class="fas fa-users"></i>
                                        <span>协作总结</span>
                                    </div>
                                </div>
                                <div class="message-content">
                                    <p>根据法律专家和财务分析师的协作分析，我们得出以下综合结论：</p>
                                    
                                    <p>这份采购合同存在严重的法律和财务风险，主要集中在：</p>
                                    <ol>
                                        <li>付款条款过于有利于供应商（70%预付款 + 缺乏担保）</li>
                                        <li>合同终止条款对我方不公平</li>
                                        <li>价格高于市场平均12%</li>
                                        <li>交付时间表存在冲突并缺乏明确的延期赔偿机制</li>
                                    </ol>
                                    
                                    <p><strong>整体建议</strong>：不建议按当前条款签署合同，应进行重新谈判，重点关注付款条件、终止条款和价格。如需具体修改建议，可以请法律专家提供详细修改意见。</p>
                                    
                                    <div class="message-actions">
                                        <a href="#" class="action-button primary">
                                            <i class="fas fa-file-signature"></i>谈判要点
                                        </a>
                                        <a href="#" class="action-button">
                                            <i class="fas fa-file-export"></i>导出报告
                                        </a>
                                        <a href="#" class="action-button">
                                            <i class="fas fa-user-plus"></i>添加专家
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="conversation-footer">
                            <div class="prompt-input-container">
                                <textarea class="prompt-input" placeholder="输入您的问题或指令..."></textarea>
                                
                                <div class="prompt-actions">
                                    <div class="prompt-targets">
                                        <div class="target-agent selected">
                                            <i class="fas fa-users"></i>
                                            <span>所有Agent</span>
                                        </div>
                                        <div class="target-agent">
                                            <i class="fas fa-gavel"></i>
                                            <span>法律专家</span>
                                        </div>
                                        <div class="target-agent">
                                            <i class="fas fa-chart-line"></i>
                                            <span>财务分析师</span>
                                        </div>
                                    </div>
                                    
                                    <div class="prompt-submit">
                                        <button class="submit-options-btn">
                                            <i class="fas fa-paperclip"></i>
                                        </button>
                                        <button class="submit-btn">
                                            <i class="fas fa-paper-plane"></i>
                                            <span>发送</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 洞察面板 -->
                    <div class="insights-panel">
                        <div class="insights-header">
                            <h5 class="insights-title">
                                <i class="fas fa-lightbulb me-2"></i>
                                关键洞察与发现
                            </h5>
                        </div>
                        
                        <div class="insights-body">
                            <!-- 法律洞察 -->
                            <div class="insights-section">
                                <div class="insights-section-header">
                                    <div>法律洞察</div>
                                    <div>
                                        <i class="fas fa-exclamation-circle text-danger"></i>
                                        <span class="ms-1">高风险</span>
                                    </div>
                                </div>
                                <div class="insights-section-body">
                                    <div class="insights-agent">
                                        <div class="insights-agent-icon legal">
                                            <i class="fas fa-gavel"></i>
                                        </div>
                                        <div class="insights-agent-name">法律专家</div>
                                    </div>
                                    
                                    <div class="key-finding key-finding-critical">
                                        <div class="key-finding-content">
                                            付款条款（第12条）预付款比例过高（70%），缺乏担保机制
                                        </div>
                                    </div>
                                    <div class="key-finding key-finding-critical">
                                        <div class="key-finding-content">
                                            终止条款（第15条）严重不平等，对方可提前15天通知终止，我方需90天
                                        </div>
                                    </div>
                                    <div class="key-finding key-finding-warning">
                                        <div class="key-finding-content">
                                            交付时间（第8条）与附录B存在冲突，且缺乏延期赔偿条款
                                        </div>
                                    </div>
                                    
                                    <div class="findings-actions">
                                        <button class="findings-action-btn">
                                            <i class="fas fa-list-alt"></i>
                                            <span>查看全部</span>
                                        </button>
                                    </div>
                                    
                                    <div class="insight-meta">
                                        <div class="insight-meta-item">
                                            <i class="fas fa-file-contract"></i>
                                            <span>供应商采购合同-2025.docx</span>
                                        </div>
                                        <div class="insight-meta-item">
                                            <i class="fas fa-clock"></i>
                                            <span>2分钟前</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 财务洞察 -->
                            <div class="insights-section">
                                <div class="insights-section-header">
                                    <div>财务洞察</div>
                                    <div>
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                        <span class="ms-1">中风险</span>
                                    </div>
                                </div>
                                <div class="insights-section-body">
                                    <div class="insights-agent">
                                        <div class="insights-agent-icon financial">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                        <div class="insights-agent-name">财务分析师</div>
                                    </div>
                                    
                                    <div class="key-finding key-finding-warning">
                                        <div class="key-finding-content">
                                            70%预付款将给Q3现金流带来显著压力，可能需动用信用额度
                                        </div>
                                    </div>
                                    <div class="key-finding key-finding-warning">
                                        <div class="key-finding-content">
                                            合同总价125万元比市场平均高出12%，存在降价空间
                                        </div>
                                    </div>
                                    <div class="key-finding key-finding-positive">
                                        <div class="key-finding-content">
                                            建议采用"30%预付+60%交付+10%验收"的阶段式付款方式
                                        </div>
                                    </div>
                                    
                                    <div class="findings-actions">
                                        <button class="findings-action-btn">
                                            <i class="fas fa-list-alt"></i>
                                            <span>查看全部</span>
                                        </button>
                                    </div>
                                    
                                    <div class="insight-meta">
                                        <div class="insight-meta-item">
                                            <i class="fas fa-file-contract"></i>
                                            <span>供应商采购合同-2025.docx</span>
                                        </div>
                                        <div class="insight-meta-item">
                                            <i class="fas fa-clock"></i>
                                            <span>1分钟前</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 协作建议 -->
                            <div class="insights-section">
                                <div class="insights-section-header">
                                    <div>协作建议</div>
                                    <div>
                                        <i class="fas fa-lightbulb text-primary"></i>
                                        <span class="ms-1">优先行动</span>
                                    </div>
                                </div>
                                <div class="insights-section-body">
                                    <div class="insights-agent">
                                        <div class="insights-agent-icon" style="background-color: #4A6CF7;">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <div class="insights-agent-name">协作洞察</div>
                                    </div>
                                    
                                    <div class="key-finding">
                                        <div class="key-finding-content">
                                            <strong>不建议按当前条款签署合同</strong>，需重新谈判以降低法律和财务风险
                                        </div>
                                    </div>
                                    <div class="key-finding">
                                        <div class="key-finding-content">
                                            谈判重点：降低预付款比例、修改不平等终止条款、降低合同总价、明确交付时间表
                                        </div>
                                    </div>
                                    <div class="key-finding">
                                        <div class="key-finding-content">
                                            可请法律专家提供详细的条款修改建议，作为谈判参考
                                        </div>
                                    </div>
                                    
                                    <div class="findings-actions">
                                        <button class="findings-action-btn">
                                            <i class="fas fa-file-signature"></i>
                                            <span>生成谈判要点</span>
                                        </button>
                                        <button class="findings-action-btn">
                                            <i class="fas fa-file-export"></i>
                                            <span>导出报告</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化变量
        const promptInput = document.querySelector('.prompt-input');
        const sendButton = document.querySelector('.submit-btn');
        const targetAgents = document.querySelectorAll('.target-agent');
        const agentCards = document.querySelectorAll('.agent-card');
        const documentItems = document.querySelectorAll('.document-item');
        
        // 调整输入框高度
        if (promptInput) {
            promptInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // Enter发送，Shift+Enter换行
            promptInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (sendButton) sendButton.click();
                }
            });
        }
        
        // 发送按钮点击
        if (sendButton) {
            sendButton.addEventListener('click', function() {
                if (!promptInput || !promptInput.value.trim()) return;
                
                // 获取目标Agent
                const selectedTarget = document.querySelector('.target-agent.selected');
                const targetName = selectedTarget ? selectedTarget.querySelector('span').textContent : '所有Agent';
                
                // 添加用户消息
                addUserMessage(promptInput.value.trim(), targetName);
                
                // 清空输入框
                promptInput.value = '';
                promptInput.style.height = 'auto';
                
                // 滚动到底部
                scrollToBottom();
                
                // 模拟Agent响应
                simulateAgentResponses(targetName);
            });
        }
        
        // 目标Agent选择
        if (targetAgents.length > 0) {
            targetAgents.forEach(agent => {
                agent.addEventListener('click', function() {
                    targetAgents.forEach(a => a.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }
        
        // Agent卡片选择
        if (agentCards.length > 0) {
            agentCards.forEach(card => {
                card.addEventListener('click', function() {
                    agentCards.forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 自动选择对应的目标Agent
                    const agentName = this.querySelector('.agent-name').textContent;
                    targetAgents.forEach(agent => {
                        if (agent.querySelector('span').textContent === agentName) {
                            targetAgents.forEach(a => a.classList.remove('selected'));
                            agent.classList.add('selected');
                        }
                    });
                });
            });
        }
        
        // 文档项选择
        if (documentItems.length > 0) {
            documentItems.forEach(item => {
                item.addEventListener('click', function() {
                    this.classList.toggle('selected');
                });
            });
        }
        
        // 消息操作按钮绑定
        const actionButtons = document.querySelectorAll('.message-action-btn, .findings-action-btn');
        if (actionButtons.length > 0) {
            actionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const action = this.querySelector('span').textContent;
                    if (promptInput) {
                        promptInput.value = `请${action}`;
                        promptInput.focus();
                        promptInput.dispatchEvent(new Event('input'));
                    }
                });
            });
        }
        
        // 工作坊操作按钮绑定
        const workshopButtons = document.querySelectorAll('.workshop-action-btn');
        if (workshopButtons.length > 0) {
            workshopButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const action = this.querySelector('span').textContent;
                    if (action === '保存分析') {
                        alert('分析结果已保存！');
                    } else if (action === '历史会话') {
                        // 模拟历史会话加载
                        console.log('加载历史会话');
                    } else if (action === '设置') {
                        // 模拟设置面板
                        console.log('打开设置面板');
                    }
                });
            });
        }
        
        // 添加用户消息
        function addUserMessage(content, targetName) {
            const conversationBody = document.querySelector('.conversation-body');
            if (!conversationBody) return;
            
            const messageHTML = `
                <div class="collaboration-message">
                    <div class="message-agents">
                        <div class="message-agent from">
                            <i class="fas fa-user"></i>
                            <span>您</span>
                        </div>
                        <div class="message-agent">
                            <i class="fas fa-arrow-right"></i>
                            <span>${targetName}</span>
                        </div>
                    </div>
                    <div class="message-content">
                        <p>${content}</p>
                    </div>
                </div>
            `;
            
            conversationBody.insertAdjacentHTML('beforeend', messageHTML);
        }
        
        // 模拟Agent响应
        function simulateAgentResponses(targetName) {
            const conversationBody = document.querySelector('.conversation-body');
            if (!conversationBody) return;
            
            // 添加处理中消息
            const processingHTML = `
                <div class="collaboration-message processing-message">
                    <div class="message-content">
                        <p><i class="fas fa-sync-alt fa-spin me-2"></i> <strong>Agent协作团队正在处理您的请求...</strong></p>
                        ${targetName === '所有Agent' ? 
                            `<p>法律专家正在分析相关法律问题</p>
                            <p>财务分析师正在评估财务影响</p>` : 
                            `<p>${targetName}正在分析您的请求</p>`}
                    </div>
                </div>
            `;
            
            conversationBody.insertAdjacentHTML('beforeend', processingHTML);
            scrollToBottom();
            
            // 模拟延迟后添加回复
            setTimeout(() => {
                // 移除处理中消息
                const processingMessage = document.querySelector('.processing-message');
                if (processingMessage) processingMessage.remove();
                
                // 根据目标Agent添加不同回复
                if (targetName === '所有Agent') {
                    addCollaborativeResponse();
                } else if (targetName === '法律专家') {
                    addLegalAgentResponse();
                } else if (targetName === '财务分析师') {
                    addFinancialAgentResponse();
                } else {
                    addGenericAgentResponse(targetName);
                }
            }, 2000);
        }
        
        // 添加协作响应
        function addCollaborativeResponse() {
            const conversationBody = document.querySelector('.conversation-body');
            if (!conversationBody) return;
            
            const messageHTML = `
                <div class="collaboration-message">
                    <div class="message-agents">
                        <div class="message-agent from">
                            <i class="fas fa-users"></i>
                            <span>协作团队</span>
                        </div>
                    </div>
                    <div class="message-content">
                        <p>我们需要更多信息来提供精确的协作分析。您可以：</p>
                        <ol>
                            <li>上传更多相关文档进行全面分析</li>
                            <li>指定具体的问题领域（如法律风险、财务影响、流程优化等）</li>
                            <li>选择特定Agent深入探讨专业问题</li>
                        </ol>
                        <p>同时，根据已有的合同分析，我们建议您关注以下方面：</p>
                        <ul>
                            <li>重新谈判付款条款，降低预付款比例并增加担保措施</li>
                            <li>修正不平等的终止条款，确保双方权利对等</li>
                            <li>协商降低总价（当前高于市场均价12%）</li>
                            <li>明确交付时间表并添加延期赔偿机制</li>
                        </ul>
                        
                        <div class="message-actions">
                            <button class="message-action-btn primary">
                                <i class="fas fa-file-signature"></i>
                                <span>生成谈判要点</span>
                            </button>
                            <button class="message-action-btn">
                                <i class="fas fa-file-export"></i>
                                <span>导出分析报告</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            conversationBody.insertAdjacentHTML('beforeend', messageHTML);
            bindNewActionButtons();
            scrollToBottom();
        }
        
        // 添加法律专家响应
        function addLegalAgentResponse() {
            const conversationBody = document.querySelector('.conversation-body');
            if (!conversationBody) return;
            
            const messageHTML = `
                <div class="collaboration-message">
                    <div class="message-agents">
                        <div class="message-agent from">
                            <i class="fas fa-gavel"></i>
                            <span>法律专家</span>
                        </div>
                        <div class="message-agent">
                            <i class="fas fa-clock"></i>
                            <span>刚刚</span>
                        </div>
                    </div>
                    <div class="message-content">
                        <p>作为法律专家，我可以提供以下具体的合同修改建议：</p>
                        
                        <ol>
                            <li><strong>付款条款（第12条）</strong>：修改为"30%预付款+60%交付验收+10%质保金"结构，并要求供应商提供不低于预付款金额的银行履约保函。</li>
                            <li><strong>终止条款（第15条）</strong>：修改为双方终止通知期一致，建议均为30天，并明确列举可单方面终止的情形（如重大违约、无法交付等）。</li>
                            <li><strong>交付时间（第8条）</strong>：统一合同正文与附录的交付时间表，增加延期违约金条款，如"每延期一天按合同总额的0.1%支付违约金，累计不超过合同总额的10%"。</li>
                            <li><strong>知识产权（第18条）</strong>：限定知识产权授权范围，明确我方核心技术和商业秘密不属于授权范围，增加保密义务和违约责任条款。</li>
                        </ol>
                        
                        <p>这些修改建议旨在平衡双方权益，降低我方法律风险。您可以将这些要点作为下一轮谈判的基础。</p>
                        
                        <div class="message-actions">
                            <button class="message-action-btn primary">
                                <i class="fas fa-file-word"></i>
                                <span>生成修改后的合同草稿</span>
                            </button>
                            <button class="message-action-btn">
                                <i class="fas fa-envelope"></i>
                                <span>起草谈判邮件</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            conversationBody.insertAdjacentHTML('beforeend', messageHTML);
            bindNewActionButtons();
            scrollToBottom();
        }
        
        // 添加财务分析师响应
        function addFinancialAgentResponse() {
            const conversationBody = document.querySelector('.conversation-body');
            if (!conversationBody) return;
            
            const messageHTML = `
                <div class="collaboration-message">
                    <div class="message-agents">
                        <div class="message-agent from">
                            <i class="fas fa-chart-line"></i>
                            <span>财务分析师</span>
                        </div>
                        <div class="message-agent">
                            <i class="fas fa-clock"></i>
                            <span>刚刚</span>
                        </div>
                    </div>
                    <div class="message-content">
                        <p>从财务角度，我为您提供以下详细分析和建议：</p>
                        
                        <h6>现金流影响分析</h6>
                        <ul>
                            <li>当前70%预付款（875,000元）将占用Q3可支配现金流的42%，显著超出我们正常采购预算</li>
                            <li>考虑到其他项目支出，这将使Q3现金储备降至安全线以下，可能需要提前动用150万信用额度</li>
                            <li>该支出时间与季度末财务考核重叠，可能影响部门KPI达成</li>
                        </ul>
                        
                        <h6>成本优化方案</h6>
                        <ol>
                            <li><strong>付款结构优化</strong>：建议"30%预付+60%交付+10%质保"的结构，可将Q3现金流压力降低50%</li>
                            <li><strong>价格谈判空间</strong>：根据市场调研，此类设备合理价格区间为105-115万，建议目标价110万</li>
                            <li><strong>总成本管控</strong>：重新评估项目实际需求，考虑是否可分批采购或寻找替代供应商</li>
                        </ol>
                        
                        <p>如采纳上述建议，预计可节省总成本约15-20%，同时显著改善现金流状况。</p>
                        
                        <div class="message-actions">
                            <button class="message-action-btn primary">
                                <i class="fas fa-chart-area"></i>
                                <span>查看现金流预测</span>
                            </button>
                            <button class="message-action-btn">
                                <i class="fas fa-table"></i>
                                <span>成本比较表</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            conversationBody.insertAdjacentHTML('beforeend', messageHTML);
            bindNewActionButtons();
            scrollToBottom();
        }
        
        // 添加通用Agent响应
        function addGenericAgentResponse(agentName) {
            const conversationBody = document.querySelector('.conversation-body');
            if (!conversationBody) return;
            
            let icon = 'fas fa-robot';
            if (agentName === '数据分析师') icon = 'fas fa-database';
            if (agentName === '流程专家') icon = 'fas fa-sitemap';
            
            const messageHTML = `
                <div class="collaboration-message">
                    <div class="message-agents">
                        <div class="message-agent from">
                            <i class="${icon}"></i>
                            <span>${agentName}</span>
                        </div>
                        <div class="message-agent">
                            <i class="fas fa-clock"></i>
                            <span>刚刚</span>
                        </div>
                    </div>
                    <div class="message-content">
                        <p>我是${agentName}，很抱歉，我目前没有足够的上下文信息来提供详细分析。</p>
                        <p>为了给您提供更有价值的见解，我需要：</p>
                        <ul>
                            <li>相关文档数据</li>
                            <li>具体分析需求</li>
                            <li>项目背景信息</li>
                        </ul>
                        <p>您可以上传更多相关文件，或者提供更具体的问题，我将竭诚为您服务。</p>
                    </div>
                </div>
            `;
            
            conversationBody.insertAdjacentHTML('beforeend', messageHTML);
            scrollToBottom();
        }
        
        // 绑定新添加的操作按钮
        function bindNewActionButtons() {
            const newButtons = document.querySelectorAll('.message-action-btn:not([data-bound])');
            newButtons.forEach(button => {
                button.setAttribute('data-bound', 'true');
                button.addEventListener('click', function() {
                    const action = this.querySelector('span').textContent;
                    if (promptInput) {
                        promptInput.value = `请${action}`;
                        promptInput.focus();
                        promptInput.dispatchEvent(new Event('input'));
                    }
                });
            });
        }
        
        // 滚动到底部
        function scrollToBottom() {
            const conversationBody = document.querySelector('.conversation-body');
            if (conversationBody) {
                conversationBody.scrollTop = conversationBody.scrollHeight;
            }
        }
    });
</script>
{% endblock %}
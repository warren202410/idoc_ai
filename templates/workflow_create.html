{% extends "base.html" %}

{% block title %}智能流程设计器 - iDOC{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<style>
    body {
        background-color: #f8fafc;
        min-height: 100vh;
        font-family: 'Inter', sans-serif;
    }
    
    .workflow-layout {
        display: flex;
        height: calc(100vh - 1rem);
        gap: 0;
    }
    
    .workflow-sidebar {
        width: 320px;
        background: white;
        border-right: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        z-index: 100;
    }
    
    .workflow-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #f8fafc;
        position: relative;
    }
    
    .sidebar-header {
        padding: 2rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        background: white;
    }
    
    .sidebar-title {
        font-size: 1.375rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.5rem;
    }
    
    .sidebar-subtitle {
        color: #64748b;
        font-size: 0.85rem;
        line-height: 1.5;
    }
    
    .node-palette {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
    }
    
    .palette-section {
        margin-bottom: 2rem;
    }
    
    .palette-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .node-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }
    
    .palette-node {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        cursor: grab;
        transition: all 0.2s ease;
        text-align: center;
        user-select: none;
    }
    
    .palette-node:hover {
        border-color: #4f46e5;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
    }
    
    .palette-node:active {
        cursor: grabbing;
    }
    
    .node-icon {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        margin: 0 auto 0.5rem;
        color: white;
    }
    
    .node-icon.input { background-color: #10b981; }
    .node-icon.process { background-color: #4f46e5; }
    .node-icon.decision { background-color: #f59e0b; }
    .node-icon.output { background-color: #ef4444; }
    .node-icon.ai { background-color: #8b5cf6; }
    
    .node-name {
        font-size: 0.75rem;
        font-weight: 500;
        color: #374151;
        line-height: 1.2;
    }
    
    .main-header {
        background: white;
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .workflow-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }
    
    .workflow-status {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background-color: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }
    
    .header-actions {
        display: flex;
        gap: 0.75rem;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        border: none;
        cursor: pointer;
    }
    
    .btn-primary {
        background-color: #4f46e5;
        color: white;
        border: 1px solid #4f46e5;
    }
    
    .btn-primary:hover {
        background-color: #4338ca;
        border-color: #4338ca;
        color: white;
        text-decoration: none;
    }
    
    .btn-secondary {
        background-color: white;
        color: #374151;
        border: 1px solid #d1d5db;
    }
    
    .btn-secondary:hover {
        background-color: #f9fafb;
        border-color: #9ca3af;
        color: #374151;
        text-decoration: none;
    }
    
    .canvas-container {
        flex: 1;
        position: relative;
        overflow: hidden;
    }
    
    .workflow-canvas {
        width: 100%;
        height: 100%;
        background-color: #fafafa;
        background-image: 
            radial-gradient(circle, #cbd5e1 1px, transparent 1px);
        background-size: 20px 20px;
        position: relative;
        overflow: auto;
        cursor: grab;
    }
    
    .workflow-canvas:active {
        cursor: grabbing;
    }
    
    .canvas-node {
        position: absolute;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        min-width: 160px;
        padding: 1rem;
        cursor: move;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 10;
    }
    
    .canvas-node:hover {
        border-color: #4f46e5;
        box-shadow: 0 4px 16px rgba(79, 70, 229, 0.2);
    }
    
    .canvas-node.selected {
        border-color: #4f46e5;
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
    }
    
    .canvas-node.dragging {
        transform: rotate(3deg);
        z-index: 100;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    
    .node-header {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .node-icon-large {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        margin-right: 0.75rem;
        color: white;
        flex-shrink: 0;
    }
    
    .node-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #1e293b;
        flex: 1;
    }
    
    .node-content {
        font-size: 0.8rem;
        color: #64748b;
        line-height: 1.4;
    }
    
    .node-ports {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
    }
    
    .node-port {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #e2e8f0;
        border: 2px solid white;
        cursor: crosshair;
        transition: all 0.2s ease;
    }
    
    .node-port:hover {
        background-color: #4f46e5;
        transform: scale(1.3);
    }
    
    .node-port.input {
        left: -6px;
    }
    
    .node-port.output {
        right: -6px;
    }
    
    .connection-line {
        stroke: #94a3b8;
        stroke-width: 2;
        fill: none;
        marker-end: url(#arrowhead);
    }
    
    .connection-line:hover {
        stroke: #4f46e5;
        stroke-width: 3;
    }
    
    .canvas-svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 5;
    }
    
    .connection-line {
        pointer-events: all;
    }
    
    .canvas-tools {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        z-index: 50;
    }
    
    .tool-btn {
        width: 44px;
        height: 44px;
        border-radius: 8px;
        background: white;
        border: 1px solid #d1d5db;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #6b7280;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .tool-btn:hover {
        background-color: #f9fafb;
        border-color: #4f46e5;
        color: #4f46e5;
    }
    
    .tool-btn.active {
        background-color: #4f46e5;
        border-color: #4f46e5;
        color: white;
    }
    
    .minimap {
        position: absolute;
        bottom: 1rem;
        right: 1rem;
        width: 200px;
        height: 120px;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 50;
    }
    
    .minimap-canvas {
        width: 100%;
        height: 100%;
        border-radius: 8px;
    }
    
    .properties-panel {
        position: absolute;
        top: 0;
        right: -320px;
        width: 320px;
        height: 100%;
        background: white;
        border-left: 1px solid #e2e8f0;
        box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 200;
    }
    
    .properties-panel.open {
        right: 0;
    }
    
    .properties-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .properties-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
    }
    
    .properties-content {
        padding: 1.5rem;
        overflow-y: auto;
        height: calc(100% - 80px);
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #374151;
        font-size: 0.9rem;
    }
    
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.9rem;
        transition: border-color 0.2s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .empty-canvas {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #9ca3af;
        z-index: 1;
    }
    
    .empty-icon {
        width: 80px;
        height: 80px;
        border-radius: 16px;
        background: #f3f4f6;
        color: #9ca3af;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        margin: 0 auto 1.5rem;
    }
    
    .empty-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #6b7280;
    }
    
    .empty-desc {
        color: #9ca3af;
        margin-bottom: 2rem;
        max-width: 300px;
    }
    
    .zoom-controls {
        position: absolute;
        bottom: 1rem;
        left: 1rem;
        display: flex;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 50;
    }
    
    .zoom-btn {
        width: 40px;
        height: 40px;
        border: none;
        background: white;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .zoom-btn:first-child {
        border-top-left-radius: 8px;
        border-bottom-left-radius: 8px;
    }
    
    .zoom-btn:last-child {
        border-top-right-radius: 8px;
        border-bottom-right-radius: 8px;
    }
    
    .zoom-btn:not(:last-child) {
        border-right: 1px solid #e5e7eb;
    }
    
    .zoom-btn:hover {
        background-color: #f9fafb;
        color: #4f46e5;
    }
    
    .zoom-level {
        padding: 0 1rem;
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        border-right: 1px solid #e5e7eb;
    }
    
    @media (max-width: 1024px) {
        .workflow-layout {
            flex-direction: column;
            height: auto;
        }
        
        .workflow-sidebar {
            width: auto;
            border-right: none;
            border-bottom: 1px solid #e2e8f0;
            height: 200px;
        }
        
        .node-palette {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        
        .palette-section {
            margin-bottom: 0;
        }
        
        .node-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- 左侧导航栏 -->
    <div class="sidebar">
        <div class="sidebar-brand">
            <a href="{{ url_for('dashboard') }}">
                <div class="sidebar-brand-icon">
                    <img src="{{ url_for('static', filename='img/logo-icon.svg') }}" alt="Logo Icon" onerror="this.src='{{ url_for('static', filename='img/default-logo.png') }}'">
                </div>
                <div class="sidebar-brand-text">
                    <img src="{{ url_for('static', filename='img/logo-text.svg') }}" alt="Logo Text" onerror="this.src='{{ url_for('static', filename='img/default-logo-text.png') }}'">
                    <span>iDOC</span>
                </div>
            </a>
        </div>
        
        <!-- 导航菜单 -->
        <div class="sidebar-nav">
            <a href="{{ url_for('dashboard') }}" class="nav-item">
                <i class="fas fa-tachometer-alt"></i>
                <span>仪表板</span>
            </a>
            
            <div class="nav-item" data-bs-toggle="collapse" data-bs-target="#collapseKnowledgeBase" aria-expanded="false">
                <i class="fas fa-book"></i>
                <span>企业知识库</span>
                <i class="fas fa-chevron-down ms-auto"></i>
            </div>
            <div class="collapse" id="collapseKnowledgeBase">
                <a href="{{ url_for('knowledge_base') }}" class="nav-item ms-4 py-2">
                    <i class="fas fa-folder-open"></i>
                    <span>所有知识库</span>
                </a>
                <a href="{{ url_for('knowledge_base') }}?action=import" class="nav-item ms-4 py-2">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>导入知识</span>
                </a>
                <a href="{{ url_for('knowledge_base') }}?action=settings" class="nav-item ms-4 py-2">
                    <i class="fas fa-cogs"></i>
                    <span>知识库设置</span>
                </a>
            </div>
            
            <div class="nav-item" data-bs-toggle="collapse" data-bs-target="#collapseDocuments" aria-expanded="false">
                <i class="fas fa-file-alt"></i>
                <span>文档管理</span>
                <i class="fas fa-chevron-down ms-auto"></i>
            </div>
            <div class="collapse" id="collapseDocuments">
                <a href="{{ url_for('documents_list') }}" class="nav-item ms-4 py-2">
                    <i class="fas fa-list"></i>
                    <span>所有文档</span>
                </a>
                <a href="{{ url_for('documents_list') }}?action=upload" class="nav-item ms-4 py-2">
                    <i class="fas fa-upload"></i>
                    <span>上传文档</span>
                </a>
                <a href="{{ url_for('documents_list') }}?action=recent" class="nav-item ms-4 py-2">
                    <i class="fas fa-clock"></i>
                    <span>最近文档</span>
                </a>
                <a href="{{ url_for('documents_list') }}?action=starred" class="nav-item ms-4 py-2">
                    <i class="fas fa-star"></i>
                    <span>星标文档</span>
                </a>
            </div>
            
            <div class="nav-item" data-bs-toggle="collapse" data-bs-target="#collapseWorkflow" aria-expanded="true">
                <i class="fas fa-project-diagram"></i>
                <span>智能流程设计</span>
                <i class="fas fa-chevron-down ms-auto"></i>
            </div>
            <div class="collapse show" id="collapseWorkflow">
                <a href="{{ url_for('workflow_create') }}" class="nav-item ms-4 py-2 active">
                    <i class="fas fa-plus"></i>
                    <span>创建智能流程</span>
                </a>
                <a href="{{ url_for('workflow_create') }}?action=templates" class="nav-item ms-4 py-2">
                    <i class="fas fa-clipboard-list"></i>
                    <span>流程模板库</span>
                </a>
                <a href="{{ url_for('workflow_create') }}?action=running" class="nav-item ms-4 py-2">
                    <i class="fas fa-play-circle"></i>
                    <span>运行中流程</span>
                </a>
                <a href="{{ url_for('workflow_create') }}?action=history" class="nav-item ms-4 py-2">
                    <i class="fas fa-history"></i>
                    <span>流程执行历史</span>
                </a>
            </div>
            
            <div class="nav-item" data-bs-toggle="collapse" data-bs-target="#collapseAnalysis" aria-expanded="false">
                <i class="fas fa-chart-bar"></i>
                <span>AI分析</span>
                <i class="fas fa-chevron-down ms-auto"></i>
            </div>
            <div class="collapse" id="collapseAnalysis">
                <a href="{{ url_for('ai_analysis') }}" class="nav-item ms-4 py-2">
                    <i class="fas fa-search"></i>
                    <span>内容分析</span>
                </a>
                <a href="{{ url_for('ai_analysis') }}?action=compare" class="nav-item ms-4 py-2">
                    <i class="fas fa-not-equal"></i>
                    <span>文档对比</span>
                </a>
                <a href="{{ url_for('ai_analysis') }}?action=extract" class="nav-item ms-4 py-2">
                    <i class="fas fa-filter"></i>
                    <span>信息提取</span>
                </a>
                <a href="{{ url_for('ai_analysis') }}?action=summary" class="nav-item ms-4 py-2">
                    <i class="fas fa-compress-alt"></i>
                    <span>文档摘要</span>
                </a>
            </div>
            
            <div class="nav-item" data-bs-toggle="collapse" data-bs-target="#collapseAgent" aria-expanded="false">
                <i class="fas fa-robot"></i>
                <span>Agent Chat</span>
                <i class="fas fa-chevron-down ms-auto"></i>
            </div>
            <div class="collapse" id="collapseAgent">
                <a href="{{ url_for('agent_chat') }}" class="nav-item ms-4 py-2">
                    <i class="fas fa-comments"></i>
                    <span>新会话</span>
                </a>
                <a href="{{ url_for('agent_chat_history') }}" class="nav-item ms-4 py-2">
                    <i class="fas fa-history"></i>
                    <span>聊天历史</span>
                </a>
                <a href="{{ url_for('multi_agent_workshop') }}" class="nav-item ms-4 py-2">
                    <i class="fas fa-users-cog"></i>
                    <span>多Agent协作</span>
                </a>
                <a href="{{ url_for('agent_settings') }}" class="nav-item ms-4 py-2">
                    <i class="fas fa-sliders-h"></i>
                    <span>Agent设置</span>
                </a>
            </div>
            
            <div class="nav-section">用户</div>
            
            <a href="{{ url_for('account_settings') }}" class="nav-item">
                <i class="fas fa-user-cog"></i>
                <span>账户设置</span>
            </a>
            
            <a href="{{ url_for('notifications') }}" class="nav-item">
                <i class="fas fa-bell"></i>
                <span>通知</span>
                <span class="badge rounded-pill bg-primary ms-auto">3</span>
            </a>
            
            <a href="{{ url_for('logout') }}" class="nav-item">
                <i class="fas fa-sign-out-alt"></i>
                <span>退出登录</span>
            </a>
        </div>
    </div>
    
    <!-- 主要工作流界面 -->
    <div class="main-content">
        <div class="workflow-layout">
            <!-- 左侧组件面板 -->
            <div class="workflow-sidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">组件工具箱</h2>
                    <p class="sidebar-subtitle">拖拽组件到画布上构建智能处理流程</p>
                </div>
                
                <div class="node-palette">
                    <div class="palette-section">
                        <div class="palette-title">输入组件</div>
                        <div class="node-grid">
                            <div class="palette-node" draggable="true" data-type="file-input">
                                <div class="node-icon input">
                                    <i class="fas fa-file-upload"></i>
                                </div>
                                <div class="node-name">文档输入</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="folder-input">
                                <div class="node-icon input">
                                    <i class="fas fa-folder-open"></i>
                                </div>
                                <div class="node-name">文件夹输入</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="url-input">
                                <div class="node-icon input">
                                    <i class="fas fa-globe"></i>
                                </div>
                                <div class="node-name">网页抓取</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="api-input">
                                <div class="node-icon input">
                                    <i class="fas fa-plug"></i>
                                </div>
                                <div class="node-name">API数据源</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="palette-section">
                        <div class="palette-title">AI处理组件</div>
                        <div class="node-grid">
                            <div class="palette-node" draggable="true" data-type="text-extract">
                                <div class="node-icon ai">
                                    <i class="fas fa-font"></i>
                                </div>
                                <div class="node-name">文本提取</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="ai-classify">
                                <div class="node-icon ai">
                                    <i class="fas fa-tags"></i>
                                </div>
                                <div class="node-name">智能分类</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="ai-summary">
                                <div class="node-icon ai">
                                    <i class="fas fa-compress-alt"></i>
                                </div>
                                <div class="node-name">内容摘要</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="ai-translate">
                                <div class="node-icon ai">
                                    <i class="fas fa-language"></i>
                                </div>
                                <div class="node-name">智能翻译</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="ocr-process">
                                <div class="node-icon ai">
                                    <i class="fas fa-eye"></i>
                                </div>
                                <div class="node-name">OCR识别</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="sentiment">
                                <div class="node-icon ai">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="node-name">情感分析</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="palette-section">
                        <div class="palette-title">数据处理</div>
                        <div class="node-grid">
                            <div class="palette-node" draggable="true" data-type="filter">
                                <div class="node-icon process">
                                    <i class="fas fa-filter"></i>
                                </div>
                                <div class="node-name">数据过滤</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="transform">
                                <div class="node-icon process">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                                <div class="node-name">数据转换</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="merge">
                                <div class="node-icon process">
                                    <i class="fas fa-code-branch"></i>
                                </div>
                                <div class="node-name">数据合并</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="validate">
                                <div class="node-icon process">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="node-name">数据验证</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="palette-section">
                        <div class="palette-title">决策控制</div>
                        <div class="node-grid">
                            <div class="palette-node" draggable="true" data-type="condition">
                                <div class="node-icon decision">
                                    <i class="fas fa-question"></i>
                                </div>
                                <div class="node-name">条件判断</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="loop">
                                <div class="node-icon decision">
                                    <i class="fas fa-redo"></i>
                                </div>
                                <div class="node-name">循环处理</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="switch">
                                <div class="node-icon decision">
                                    <i class="fas fa-random"></i>
                                </div>
                                <div class="node-name">分支选择</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="delay">
                                <div class="node-icon decision">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="node-name">延时等待</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="palette-section">
                        <div class="palette-title">输出组件</div>
                        <div class="node-grid">
                            <div class="palette-node" draggable="true" data-type="kb-save">
                                <div class="node-icon output">
                                    <i class="fas fa-database"></i>
                                </div>
                                <div class="node-name">保存到知识库</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="file-export">
                                <div class="node-icon output">
                                    <i class="fas fa-download"></i>
                                </div>
                                <div class="node-name">导出文件</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="email-send">
                                <div class="node-icon output">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <div class="node-name">发送邮件</div>
                            </div>
                            
                            <div class="palette-node" draggable="true" data-type="webhook">
                                <div class="node-icon output">
                                    <i class="fas fa-paper-plane"></i>
                                </div>
                                <div class="node-name">Webhook通知</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧画布区域 -->
            <div class="workflow-main">
                <div class="main-header">
                    <div class="header-left">
                        <h1 class="workflow-title">智能文档处理流程</h1>
                        <div class="workflow-status">草稿</div>
                    </div>
                    
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="saveWorkflow()">
                            <i class="fas fa-save"></i>
                            保存草稿
                        </button>
                        <button class="btn btn-secondary" onclick="previewWorkflow()">
                            <i class="fas fa-eye"></i>
                            预览
                        </button>
                        <button class="btn btn-primary" onclick="runWorkflow()">
                            <i class="fas fa-play"></i>
                            运行流程
                        </button>
                    </div>
                </div>
                
                <div class="canvas-container">
                    <div class="workflow-canvas" id="workflow-canvas">
                        <!-- 空状态 -->
                        <div class="empty-canvas" id="empty-canvas">
                            <div class="empty-icon">
                                <i class="fas fa-mouse-pointer"></i>
                            </div>
                            <div class="empty-title">开始构建智能流程</div>
                            <div class="empty-desc">从左侧拖拽组件到画布上，创建您的文档处理流程</div>
                        </div>
                        
                        <!-- SVG连线层 -->
                        <svg class="canvas-svg" id="canvas-svg">
                            <defs>
                                <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                                </marker>
                            </defs>
                        </svg>
                    </div>
                    
                    <!-- 画布工具栏 -->
                    <div class="canvas-tools">
                        <div class="tool-btn" title="选择工具" onclick="setTool('select')" data-tool="select">
                            <i class="fas fa-mouse-pointer"></i>
                        </div>
                        <div class="tool-btn" title="连线工具" onclick="setTool('connect')" data-tool="connect">
                            <i class="fas fa-bezier-curve"></i>
                        </div>
                        <div class="tool-btn" title="删除工具" onclick="setTool('delete')" data-tool="delete">
                            <i class="fas fa-trash"></i>
                        </div>
                        <div class="tool-btn" title="属性面板" onclick="toggleProperties()">
                            <i class="fas fa-cog"></i>
                        </div>
                    </div>
                    
                    <!-- 缩放控制 -->
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoomOut()">
                            <i class="fas fa-minus"></i>
                        </button>
                        <div class="zoom-level" id="zoom-level">100%</div>
                        <button class="zoom-btn" onclick="zoomIn()">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="zoom-btn" onclick="fitToScreen()">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    
                    <!-- 小地图 -->
                    <div class="minimap">
                        <canvas class="minimap-canvas" id="minimap-canvas"></canvas>
                    </div>
                </div>
                
                <!-- 属性面板 -->
                <div class="properties-panel" id="properties-panel">
                    <div class="properties-header">
                        <h3 class="properties-title">组件属性</h3>
                    </div>
                    <div class="properties-content" id="properties-content">
                        <p style="color: #9ca3af; text-align: center; margin-top: 2rem;">
                            选择一个组件查看其属性设置
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentTool = 'select';
    let selectedNode = null;
    let draggedNode = null;
    let connections = [];
    let nodes = [];
    let zoomLevel = 1;
    let canvasOffset = { x: 0, y: 0 };
    let isConnecting = false;
    let connectStart = null;
    
    // 节点模板
    const nodeTemplates = {
        'file-input': {
            name: '文档输入',
            icon: 'fas fa-file-upload',
            type: 'input',
            description: '选择要处理的文档文件',
            properties: {
                'file-types': { label: '支持的文件类型', type: 'select', options: ['PDF', 'Word', 'Excel', 'PowerPoint', '全部'], default: '全部' },
                'max-size': { label: '最大文件大小(MB)', type: 'number', default: 100 },
                'batch-mode': { label: '批量处理', type: 'checkbox', default: false }
            }
        },
        'text-extract': {
            name: '文本提取',
            icon: 'fas fa-font',
            type: 'ai',
            description: '从文档中提取纯文本内容',
            properties: {
                'extract-mode': { label: '提取模式', type: 'select', options: ['全文提取', '智能提取', '结构化提取'], default: '智能提取' },
                'preserve-format': { label: '保留格式', type: 'checkbox', default: true },
                'language': { label: '文档语言', type: 'select', options: ['自动检测', '中文', '英文', '日文'], default: '自动检测' }
            }
        },
        'ai-classify': {
            name: '智能分类',
            icon: 'fas fa-tags',
            type: 'ai',
            description: '使用AI对文档内容进行智能分类',
            properties: {
                'categories': { label: '分类标签', type: 'text', default: '法务,财务,人事,技术,其他' },
                'confidence-threshold': { label: '置信度阈值', type: 'number', default: 0.8 },
                'multi-label': { label: '多标签分类', type: 'checkbox', default: true }
            }
        },
        'kb-save': {
            name: '保存到知识库',
            icon: 'fas fa-database',
            type: 'output',
            description: '将处理结果保存到指定知识库',
            properties: {
                'target-kb': { label: '目标知识库', type: 'select', options: ['企业法务知识库', '财务管理知识库', '人力资源知识库'], default: '企业法务知识库' },
                'auto-index': { label: '自动建立索引', type: 'checkbox', default: true },
                'version-control': { label: '版本控制', type: 'checkbox', default: true }
            }
        }
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        initializeCanvas();
        setupDragAndDrop();
        setupCanvasInteraction();
    });
    
    function initializeCanvas() {
        const canvas = document.getElementById('workflow-canvas');
        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('dragover', handleDragOver);
        canvas.addEventListener('drop', handleDrop);
        
        // 设置默认工具
        setTool('select');
    }
    
    function setupDragAndDrop() {
        const paletteNodes = document.querySelectorAll('.palette-node');
        
        paletteNodes.forEach(node => {
            node.addEventListener('dragstart', function(e) {
                e.dataTransfer.setData('text/plain', this.dataset.type);
                e.dataTransfer.effectAllowed = 'copy';
            });
        });
    }
    
    function setupCanvasInteraction() {
        const canvas = document.getElementById('workflow-canvas');
        
        canvas.addEventListener('mousedown', function(e) {
            if (e.target.classList.contains('canvas-node')) {
                startNodeDrag(e);
            }
        });
        
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
    }
    
    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
    }
    
    function handleDrop(e) {
        e.preventDefault();
        const nodeType = e.dataTransfer.getData('text/plain');
        const rect = e.currentTarget.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        createNode(nodeType, x, y);
        hideEmptyState();
    }
    
    function createNode(type, x, y) {
        const template = nodeTemplates[type];
        if (!template) return;
        
        const nodeId = 'node-' + Date.now();
        const node = {
            id: nodeId,
            type: type,
            x: x - 80, // 居中
            y: y - 40,
            template: template
        };
        
        nodes.push(node);
        renderNode(node);
    }
    
    function renderNode(node) {
        const canvas = document.getElementById('workflow-canvas');
        const nodeElement = document.createElement('div');
        nodeElement.className = 'canvas-node';
        nodeElement.id = node.id;
        nodeElement.style.left = node.x + 'px';
        nodeElement.style.top = node.y + 'px';
        
        const iconClass = node.template.type;
        nodeElement.innerHTML = `
            <div class="node-header">
                <div class="node-icon-large ${iconClass}">
                    <i class="${node.template.icon}"></i>
                </div>
                <div class="node-title">${node.template.name}</div>
            </div>
            <div class="node-content">${node.template.description}</div>
            <div class="node-ports">
                <div class="node-port input" data-port="input"></div>
                <div class="node-port output" data-port="output"></div>
            </div>
        `;
        
        nodeElement.addEventListener('click', function(e) {
            e.stopPropagation();
            selectNode(node.id);
        });
        
        canvas.appendChild(nodeElement);
    }
    
    function selectNode(nodeId) {
        // 清除之前的选择
        document.querySelectorAll('.canvas-node').forEach(n => {
            n.classList.remove('selected');
        });
        
        // 选择新节点
        const nodeElement = document.getElementById(nodeId);
        nodeElement.classList.add('selected');
        selectedNode = nodeId;
        
        // 更新属性面板
        const node = nodes.find(n => n.id === nodeId);
        if (node) {
            updatePropertiesPanel(node);
        }
    }
    
    function updatePropertiesPanel(node) {
        const content = document.getElementById('properties-content');
        const properties = node.template.properties || {};
        
        let html = `
            <div class="form-group">
                <label class="form-label">组件名称</label>
                <input type="text" class="form-control" value="${node.template.name}" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">组件描述</label>
                <textarea class="form-control" rows="2" readonly>${node.template.description}</textarea>
            </div>
        `;
        
        Object.entries(properties).forEach(([key, prop]) => {
            html += `<div class="form-group">`;
            html += `<label class="form-label">${prop.label}</label>`;
            
            if (prop.type === 'select') {
                html += `<select class="form-control" data-property="${key}">`;
                prop.options.forEach(option => {
                    const selected = option === prop.default ? 'selected' : '';
                    html += `<option value="${option}" ${selected}>${option}</option>`;
                });
                html += `</select>`;
            } else if (prop.type === 'checkbox') {
                const checked = prop.default ? 'checked' : '';
                html += `<label style="display: flex; align-items: center; gap: 0.5rem;">`;
                html += `<input type="checkbox" ${checked} data-property="${key}">`;
                html += `<span>启用</span></label>`;
            } else if (prop.type === 'number') {
                html += `<input type="number" class="form-control" value="${prop.default}" data-property="${key}">`;
            } else {
                html += `<input type="text" class="form-control" value="${prop.default}" data-property="${key}">`;
            }
            
            html += `</div>`;
        });
        
        content.innerHTML = html;
    }
    
    function startNodeDrag(e) {
        if (currentTool !== 'select') return;
        
        const nodeElement = e.target.closest('.canvas-node');
        if (!nodeElement) return;
        
        draggedNode = {
            element: nodeElement,
            startX: e.clientX,
            startY: e.clientY,
            initialX: parseInt(nodeElement.style.left),
            initialY: parseInt(nodeElement.style.top)
        };
        
        nodeElement.classList.add('dragging');
        e.preventDefault();
    }
    
    function handleMouseMove(e) {
        if (!draggedNode) return;
        
        const deltaX = e.clientX - draggedNode.startX;
        const deltaY = e.clientY - draggedNode.startY;
        
        const newX = draggedNode.initialX + deltaX;
        const newY = draggedNode.initialY + deltaY;
        
        draggedNode.element.style.left = newX + 'px';
        draggedNode.element.style.top = newY + 'px';
        
        // 更新节点数据
        const node = nodes.find(n => n.id === draggedNode.element.id);
        if (node) {
            node.x = newX;
            node.y = newY;
        }
    }
    
    function handleMouseUp(e) {
        if (draggedNode) {
            draggedNode.element.classList.remove('dragging');
            draggedNode = null;
        }
    }
    
    function handleCanvasClick(e) {
        if (e.target === e.currentTarget) {
            // 点击空白区域，取消选择
            document.querySelectorAll('.canvas-node').forEach(n => {
                n.classList.remove('selected');
            });
            selectedNode = null;
            
            // 清空属性面板
            document.getElementById('properties-content').innerHTML = `
                <p style="color: #9ca3af; text-align: center; margin-top: 2rem;">
                    选择一个组件查看其属性设置
                </p>
            `;
        }
    }
    
    function hideEmptyState() {
        const emptyState = document.getElementById('empty-canvas');
        emptyState.style.display = 'none';
    }
    
    function setTool(tool) {
        currentTool = tool;
        
        // 更新工具按钮状态
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        const toolBtn = document.querySelector(`[data-tool="${tool}"]`);
        if (toolBtn) {
            toolBtn.classList.add('active');
        }
        
        // 更新画布光标
        const canvas = document.getElementById('workflow-canvas');
        canvas.style.cursor = tool === 'select' ? 'grab' : tool === 'connect' ? 'crosshair' : 'pointer';
    }
    
    function toggleProperties() {
        const panel = document.getElementById('properties-panel');
        panel.classList.toggle('open');
    }
    
    function zoomIn() {
        zoomLevel = Math.min(zoomLevel * 1.2, 3);
        updateZoom();
    }
    
    function zoomOut() {
        zoomLevel = Math.max(zoomLevel / 1.2, 0.3);
        updateZoom();
    }
    
    function fitToScreen() {
        zoomLevel = 1;
        updateZoom();
    }
    
    function updateZoom() {
        const canvas = document.getElementById('workflow-canvas');
        canvas.style.transform = `scale(${zoomLevel})`;
        canvas.style.transformOrigin = 'top left';
        
        document.getElementById('zoom-level').textContent = Math.round(zoomLevel * 100) + '%';
    }
    
    function saveWorkflow() {
        const workflowData = {
            nodes: nodes,
            connections: connections,
            name: '智能文档处理流程',
            description: '自动化文档处理和知识库管理'
        };
        
        console.log('保存工作流:', workflowData);
        alert('工作流已保存为草稿');
    }
    
    function previewWorkflow() {
        if (nodes.length === 0) {
            alert('请先添加一些组件到画布上');
            return;
        }
        
        alert('预览功能开发中，敬请期待！');
    }
    
    function runWorkflow() {
        if (nodes.length === 0) {
            alert('请先添加一些组件到画布上');
            return;
        }
        
        alert('工作流开始执行，您可以在"运行中流程"页面查看进度');
    }
</script>
{% endblock %}